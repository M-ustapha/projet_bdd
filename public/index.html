<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Films</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="mt-4">Ajouter un Film</h1>
        <form action="/ajouterFilm" method="POST" enctype="multipart/form-data" class="mb-4">
            <div class="form-group">
                <input type="text" name="titre" class="form-control" placeholder="Titre" required>
            </div>
            <div class="form-group">
                <input type="text" name="réalisateur" class="form-control" placeholder="Réalisateur" required>
            </div>
            <div class="form-group">
                <input type="number" name="année" class="form-control" placeholder="Année" required>
            </div>
            <div class="form-group">
                <input type="text" name="salle" class="form-control" placeholder="Salle" required>
            </div>
            <div class="form-group">
                <input type="time" name="horaire" class="form-control" required>
            </div>
            <div class="form-group">
                <input type="text" name="langue" class="form-control" placeholder="Langue" required>
            </div>
            <div class="form-group">
                <input type="file" name="image" accept="image/*" class="form-control-file" required>
            </div>
            <button type="submit" class="btn btn-primary">Ajouter</button>
        </form>

        <h1 class="mt-4">Liste des Films</h1>
        <div class="row" id="filmList"></div>

        <!-- Modal pour modifier un film -->
        <div class="modal fade" id="modifierFilmModal" tabindex="-1" role="dialog" aria-labelledby="modifierFilmModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modifierFilmModalLabel">Modifier un Film</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="formModifierFilm" enctype="multipart/form-data">
                            <input type="hidden" id="filmId">
                            <div class="form-group">
                                <input type="text" id="titre" class="form-control" placeholder="Titre" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="réalisateur" class="form-control" placeholder="Réalisateur" required>
                            </div>
                            <div class="form-group">
                                <input type="number" id="année" class="form-control" placeholder="Année" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="salle" class="form-control" placeholder="Salle" required>
                            </div>
                            <div class="form-group">
                                <input type="time" id="horaire" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="langue" class="form-control" placeholder="Langue" required>
                            </div>
                            <div class="form-group">
                                <input type="file" id="image" class="form-control-file">
                                <small>Si vous ne souhaitez pas changer l'image, laissez ce champ vide.</small>
                            </div>
                            <button type="submit" class="btn btn-warning">Modifier</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function fetchFilms() {
                fetch('/filmsList')
                    .then(response => response.json())
                    .then(data => {
                        const filmList = document.getElementById('filmList');
                        filmList.innerHTML = ''; // Réinitialise la liste
                        data.forEach(film => {
                            const filmDiv = document.createElement('div');
                            filmDiv.className = 'col-md-4 mb-4';
                            filmDiv.innerHTML = `
                                <div class="card">
                                    <img src="${film.image}" class="card-img-top" alt="${film.titre}">
                                    <div class="card-body">
                                        <h5 class="card-title">${film.titre}</h5>
                                        <p class="card-text">Réalisateur: ${film.réalisateur}</p>
                                        <p class="card-text">Année: ${film.année}</p>
                                        <p class="card-text">Salle: ${film.salle}</p>
                                        <p class="card-text">Horaire: ${film.horaire}</p>
                                        <p class="card-text">Langue: ${film.langue}</p>
                                        <button class="btn btn-warning" onclick="showModifierFilmModal('${film._id}')">Modifier</button>
                                        <button class="btn btn-danger" onclick="supprimerFilm('${film._id}')">Supprimer</button>
                                    </div>
                                </div>
                            `;
                            filmList.appendChild(filmDiv);
                        });
                    })
                    .catch(error => console.error('Erreur:', error));
            }

            function showModifierFilmModal(id) {
                fetch(`/filmsList`)
                    .then(response => response.json())
                    .then(data => {
                        const film = data.find(f => f._id === id);
                        if (film) {
                            document.getElementById('filmId').value = film._id;
                            document.getElementById('titre').value = film.titre;
                            document.getElementById('réalisateur').value = film.réalisateur;
                            document.getElementById('année').value = film.année;
                            document.getElementById('salle').value = film.salle;
                            document.getElementById('horaire').value = film.horaire;
                            document.getElementById('langue').value = film.langue;
                            $('#modifierFilmModal').modal('show'); // Affiche le modal
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
            }

            document.getElementById('formModifierFilm').addEventListener('submit', function (e) {
                e.preventDefault();
                const id = document.getElementById('filmId').value;

                // Crée un FormData pour gérer le fichier
                const formData = new FormData();
                formData.append('titre', document.getElementById('titre').value);
                formData.append('réalisateur', document.getElementById('réalisateur').value);
                formData.append('année', document.getElementById('année').value);
                formData.append('salle', document.getElementById('salle').value);
                formData.append('horaire', document.getElementById('horaire').value);
                formData.append('langue', document.getElementById('langue').value);
                const imageFile = document.getElementById('image').files[0];
                if (imageFile) {
                    formData.append('image', imageFile); // Ajoute le fichier image si présent
                }

                fetch(`/modifierFilm/${id}`, {
                    method: 'POST',
                    body: formData // Envoie le FormData
                })
                .then(response => {
                    if (response.ok) {
                        fetchFilms(); // Met à jour la liste des films
                        $('#modifierFilmModal').modal('hide'); // Ferme le modal
                    } else {
                        alert('Erreur lors de la modification du film');
                    }
                })
                .catch(error => console.error('Erreur:', error));
            });

            function supprimerFilm(id) {
                if (confirm('Êtes-vous sûr de vouloir supprimer ce film ?')) {
                    fetch(`/supprimerFilm/${id}`, {
                        method: 'POST'
                    })
                    .then(response => {
                        if (response.ok) {
                            fetchFilms(); // Met à jour la liste des films
                        } else {
                            alert('Erreur lors de la suppression du film');
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
                }
            }

            // Charger les films à l'initialisation
            document.addEventListener('DOMContentLoaded', fetchFilms);
        </script>
    </div>
</body>
</html>
